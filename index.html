<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>USDUT PFP — PNG Stickers</title>
<style>
  :root{
    --bg:#ffffff; --text:#0b0c10; --muted:#e6e8ef; --panel:#ffffff; --accent:#00b094;
    --gap:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; display:flex; flex-direction:column}

  /* Header con logo + titolo */
  header{
    padding:14px 18px;
    display:flex;
    align-items:center;
    border-bottom:1px solid var(--muted);
    background:var(--bg);
  }
  header .brand{
    display:flex; align-items:center; gap:10px;
  }
  header .brand .brand-logo{
    height: 1.4em; /* proporzionale alla dimensione del testo */
    width: auto; display:block; object-fit:contain; user-select:none;
  }
  header h1{ font-size:18px; margin:0; font-weight:700; white-space:nowrap; }

  main{padding:var(--gap); display:flex; flex-direction:column; gap:var(--gap)}

  /* Card / pannelli */
  .card{background:var(--panel); border:1px solid var(--muted); border-radius:14px; padding:14px}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  label{display:block; font-size:12px; color:#5d6470; margin-bottom:6px}
  input[type="file"]{display:none}
  .btn{border:1px solid var(--muted); background:var(--accent); color:#fff; padding:12px 14px; border-radius:12px; cursor:pointer; font-weight:700; min-height:44px}
  .btn:hover{filter:brightness(0.95)}
  .btn.ghost{background:#fff; color:var(--text)}
  .btn.block{display:block; width:100%}

  /* Canvas */
  .canvas-wrap{display:flex; justify-content:center; align-items:center}
  canvas{border:1px solid var(--muted); border-radius:12px; background:#f9f9f9; touch-action:none; display:block}

  /* Accordion */
  details{border:1px solid var(--muted); border-radius:12px; background:#fff; overflow:hidden}
  summary{
    list-style:none; cursor:pointer; padding:14px; font-weight:800; display:flex; align-items:center; justify-content:space-between; gap:10px; user-select:none;
    background:#fff; color:#0b0c10;
  }
  summary::-webkit-details-marker{display:none}
  .chev{transition:transform .2s ease}
  details[open] .chev{transform:rotate(180deg)}
  .panel{padding:12px 12px 16px; border-top:1px solid var(--muted); background:#fff}
  .thumbs{display:grid; grid-template-columns: repeat(3,1fr); gap:10px}
  .thumb{background:#fafbff; border:1px dashed var(--muted); height:96px; border-radius:12px; display:flex; align-items:center; justify-content:center; cursor:pointer; overflow:hidden; touch-action:manipulation}
  .thumb img{max-width:100%; max-height:100%}

  /* Slider */
  input[type=range]{width:100%; height:44px; -webkit-tap-highlight-color:transparent}

  /* Footer actions */
  .actions{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
  @media (min-width: 520px){ .actions{grid-template-columns: repeat(4,1fr)} }

  /* Desktop migliorie */
  @media (min-width: 980px){
    main{max-width: 980px; margin: 0 auto}
  }
</style>
</head>
<body>
  <!-- HEADER con logo -->
  <header>
    <div class="brand">
      <img src="/stickers/logo.png" alt="USDUT PFP logo" class="brand-logo" draggable="false" />
      <h1>USDUT PFP</h1>
    </div>
  </header>

  <main>
    <!-- Upload -->
    <section class="card">
      <div class="row" style="width:100%">
        <div style="flex:1; min-width:220px">
          <label for="upload">Base Image (optional)</label>
          <input id="upload" type="file" accept="image/*" />
          <button class="btn block" id="uploadBtn">Upload Image…</button>
        </div>
        <div style="flex:1; min-width:220px">
          <label for="scaleRange">Scale</label>
          <input id="scaleRange" type="range" min="1e-6" max="4" step="1e-6" value="1" />
        </div>
        <div style="flex:1; min-width:220px">
          <label for="rotateRange">Rotate</label>
          <input id="rotateRange" type="range" min="-180" max="180" step="1" value="0" />
        </div>
      </div>
    </section>

    <!-- Canvas -->
    <section class="card canvas-wrap">
      <canvas id="canvas"></canvas>
    </section>

    <!-- Accordion Backgrounds -->
    <details class="card">
      <summary>Backgrounds <span class="chev">▾</span></summary>
      <div class="panel">
        <div class="row" style="margin-bottom:10px">
          <button class="btn ghost" id="clearBgBtn">No Background</button>
        </div>
        <div id="bgThumbs" class="thumbs" aria-live="polite"></div>
      </div>
    </details>

    <!-- Accordion Stickers -->
    <details class="card">
      <summary>Stickers <span class="chev">▾</span></summary>
      <div class="panel">
        <div id="presetThumbs" class="thumbs" aria-live="polite"></div>
      </div>
    </details>

    <!-- Bottoni finali -->
    <section class="card">
      <div class="actions">
        <button class="btn" id="exportBtn">Export PNG</button>
        <button class="btn ghost" id="clearBtn">Remove</button>
        <button class="btn ghost" id="frontBtn">Front</button>
        <button class="btn ghost" id="flipBtn">Flip</button>
      </div>
    </section>
  </main>

<script>
  // === CONFIG ===
  const STICKERS = [
    "/stickers/sticker1.png","/stickers/sticker2.png","/stickers/sticker3.png","/stickers/sticker4.png",
    "/stickers/sticker5.png","/stickers/sticker6.png","/stickers/sticker7.png","/stickers/sticker8.png",
    "/stickers/sticker9.png","/stickers/sticker10.png","/stickers/sticker11.png","/stickers/sticker12.png"
  ];
  const BACKGROUNDS = ["/stickers/bg1.png","/stickers/bg2.png","/stickers/bg3.png","/stickers/bg4.png"];

  // === Utilities ===
  const $ = (sel, root=document) => root.querySelector(sel);

  const canvas = $('#canvas');
  const ctx = canvas.getContext('2d', { alpha: true });
  const CANVAS_SIZE = 512;

  // HiDPI: adatta il canvas alla larghezza della card
  function setupHiDPI(){
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const container = document.querySelector('.canvas-wrap');
    const containerW = Math.max(280, container.clientWidth - 4);
    const cssSize = Math.min(containerW, 720);
    canvas.style.width = cssSize + 'px';
    canvas.style.height = cssSize + 'px';
    canvas.width  = CANVAS_SIZE * dpr;
    canvas.height = CANVAS_SIZE * dpr;
    ctx.setTransform(dpr,0,0,dpr,0,0);
    draw();
  }
  window.addEventListener('resize', setupHiDPI);

  // Base layers
  let baseImage = null, bgImage = null;

  // Stickers
  const stickers = [];
  let selectedId = null;

  // Gestures
  let dragging=false, rotating=false;
  let dragOffset={x:0,y:0};
  let rotateStart={base:0, angle0:0};
  let pinch = { active:false, dist0:0, angle0:0, scale0:1, angleStart:0 };

  const ROTATE_HANDLE_OFFSET = 30, ROTATE_HANDLE_RADIUS = 14;

  function getPointer(e){
    const rect = canvas.getBoundingClientRect();
    const scaleX = CANVAS_SIZE / rect.width, scaleY = CANVAS_SIZE / rect.height;
    if(e.touches && e.touches.length){
      const t=e.touches[0];
      return {x:(t.clientX-rect.left)*scaleX, y:(t.clientY-rect.top)*scaleY};
    }
    return {x:(e.clientX-rect.left)*scaleX, y:(e.clientY-rect.top)*scaleY};
  }
  function getTwoTouchData(e){
    const rect = canvas.getBoundingClientRect();
    const scaleX = CANVAS_SIZE / rect.width, scaleY = CANVAS_SIZE / rect.height;
    const a = e.touches[0], b = e.touches[1];
    const p1 = { x:(a.clientX-rect.left)*scaleX, y:(a.clientY-rect.top)*scaleY };
    const p2 = { x:(b.clientX-rect.left)*scaleX, y:(b.clientY-rect.top)*scaleY };
    const dist = Math.hypot(p1.x-p2.x, p1.y-p2.y);
    const angle = Math.atan2(p2.y-p1.y, p2.x-p1.x);
    return { dist, angle };
  }

  function createSticker(img){
    const id = crypto.randomUUID();
    const maxSide = Math.max(img.width, img.height);
    const initScale = Math.min(1, (CANVAS_SIZE*0.35)/maxSide);
    const s = { id, img, x: CANVAS_SIZE/2, y: CANVAS_SIZE/2, scale: initScale, w: img.width, h: img.height, angle: 0, flipX: false };
    stickers.push(s); selectedId=id; syncControlsFromSelection(); draw();
  }

  function toLocal(p, s){
    let x = p.x - s.x, y = p.y - s.y;
    const ca = Math.cos(-s.angle), sa = Math.sin(-s.angle);
    const xr = x*ca - y*sa, yr = x*sa + y*ca;
    const sc = s.scale || 1e-6;
    return { x: xr / sc, y: yr / sc };
  }
  function pointInSticker(p, s){
    const lp = toLocal(p, s);
    return Math.abs(lp.x) <= s.w/2 && Math.abs(lp.y) <= s.h/2;
  }
  function isOnRotateHandle(p, s){
    const lp = toLocal(p, s);
    const hx = 0, hy = -s.h/2 - ROTATE_HANDLE_OFFSET;
    return Math.hypot(lp.x - hx, lp.y - hy) <= ROTATE_HANDLE_RADIUS;
  }

  function draw(){
    ctx.clearRect(0,0,CANVAS_SIZE,CANVAS_SIZE);
    if(bgImage){ const b=bgImage; ctx.drawImage(b.img, b.sx,b.sy,b.sw,b.sh, b.dx,b.dy,b.dw,b.dh); }
    if(baseImage){ const b=baseImage; ctx.drawImage(b.img, b.sx,b.sy,b.sw,b.sh, b.dx,b.dy,b.dw,b.dh); }
    for(const s of stickers){ drawSticker(s); }
    if(selectedId){ const s=stickers.find(x=>x.id===selectedId); if(s) drawSelection(s); }
  }
  function drawSticker(s){
    ctx.save();
    ctx.translate(s.x, s.y);
    ctx.rotate(s.angle);
    ctx.scale((s.flipX?-1:1)*s.scale, s.scale);
    ctx.drawImage(s.img, -s.w/2, -s.h/2, s.w, s.h);
    ctx.restore();
  }
  function drawSelection(s){
    ctx.save();
    ctx.translate(s.x, s.y);
    ctx.rotate(s.angle);
    ctx.strokeStyle = '#00b094';
    ctx.lineWidth = 2;
    ctx.setLineDash([6,4]);
    ctx.strokeRect(-s.w/2 * s.scale, -s.h/2 * s.scale, s.w * s.scale, s.h * s.scale);
    ctx.setLineDash([]);
    const topY = -s.h/2 * s.scale;
    const hx = 0, hy = topY - ROTATE_HANDLE_OFFSET;
    ctx.beginPath(); ctx.moveTo(0, topY); ctx.lineTo(hx, hy); ctx.stroke();
    ctx.fillStyle = '#00b094';
    ctx.beginPath(); ctx.arc(hx, hy, ROTATE_HANDLE_RADIUS, 0, Math.PI*2); ctx.fill();
    ctx.restore();
  }

  function fitImageCover(img, target){
    const tw=target, th=target, iw=img.width, ih=img.height;
    const sc=Math.max(tw/iw, th/ih), sw=tw/sc, sh=th/sc, sx=(iw-sw)/2, sy=(ih-sh)/2;
    return {img, sx,sy,sw,sh, dx:0,dy:0,dw:tw,dh:th};
  }
  function loadBaseFromFile(file){ const img=new Image(); img.onload=()=>{ baseImage=fitImageCover(img, CANVAS_SIZE); draw(); }; img.src=URL.createObjectURL(file); }
  function loadBackground(src){ const img=new Image(); img.onload=()=>{ bgImage=fitImageCover(img, CANVAS_SIZE); draw(); }; img.src=src; }
  function clearBackground(){ bgImage=null; draw(); }

  function buildPresetThumbs(){
    const tray = document.getElementById('presetThumbs'); tray.innerHTML='';
    STICKERS.forEach(src=>{
      const img = new Image(); img.src = src; img.alt='sticker';
      const cell = document.createElement('button'); cell.className='thumb'; cell.appendChild(img);
      cell.addEventListener('click', ()=>{ const i=new Image(); i.crossOrigin='anonymous'; i.onload=()=>createSticker(i); i.src=src; });
      tray.appendChild(cell);
    });
  }
  function buildBackgroundThumbs(){
    const tray = document.getElementById('bgThumbs'); tray.innerHTML='';
    BACKGROUNDS.forEach(src=>{
      const img = new Image(); img.src = src; img.alt='background';
      const cell = document.createElement('button'); cell.className='thumb'; cell.appendChild(img);
      cell.addEventListener('click', ()=> loadBackground(src));
      tray.appendChild(cell);
    });
  }

  // Mouse
  canvas.addEventListener('mousedown', e=>{
    const p=getPointer(e);
    const s=selectedId?stickers.find(x=>x.id===selectedId):null;
    if(s && isOnRotateHandle(p,s)){
      rotating = true; dragging=false;
      rotateStart = { base: Math.atan2(p.y - s.y, p.x - s.x), angle0: s.angle };
      return;
    }
    for(let i=stickers.length-1;i>=0;i--){
      const st=stickers[i];
      if(pointInSticker(p,st)){
        selectedId=st.id; syncControlsFromSelection(); draw();
        dragging=true; rotating=false;
        dragOffset={x:p.x-st.x,y:p.y-st.y};
        const idx=stickers.indexOf(st); stickers.splice(idx,1); stickers.push(st);
        return;
      }
    }
    selectedId=null; draw();
  });
  window.addEventListener('mousemove', e=>{
    const p=getPointer(e);
    if(rotating && selectedId){
      const s=stickers.find(x=>x.id===selectedId);
      const a = Math.atan2(p.y - s.y, p.x - s.x);
      s.angle = rotateStart.angle0 + (a - rotateStart.base);
      $('#rotateRange').value = (s.angle * 180 / Math.PI).toFixed(0);
      draw();
    } else if(dragging && selectedId){
      const s=stickers.find(x=>x.id===selectedId);
      s.x=p.x-dragOffset.x; s.y=p.y-dragOffset.y; draw();
    }
  });
  window.addEventListener('mouseup', ()=>{ dragging=false; rotating=false; });

  // Touch (pinch+rotate)
  canvas.addEventListener('touchstart', e=>{
    if(e.touches.length===2 && selectedId){
      const s = stickers.find(x=>x.id===selectedId);
      const {dist, angle} = getTwoTouchData(e);
      pinch = { active:true, dist0:dist, angle0:angle, scale0:s.scale, angleStart:s.angle };
      e.preventDefault(); return;
    }
    const p=getPointer(e);
    const s=selectedId?stickers.find(x=>x.id===selectedId):null;
    if(s && isOnRotateHandle(p,s)){
      rotating = true; dragging=false;
      rotateStart = { base: Math.atan2(p.y - s.y, p.x - s.x), angle0: s.angle };
      e.preventDefault(); return;
    }
    for(let i=stickers.length-1;i>=0;i--){
      const st=stickers[i];
      if(pointInSticker(p,st)){
        selectedId=st.id; syncControlsFromSelection(); draw();
        dragging=true; rotating=false;
        dragOffset={x:p.x-st.x,y:p.y-st.y};
        const idx=stickers.indexOf(st); stickers.splice(idx,1); stickers.push(st);
        e.preventDefault(); return;
      }
    }
    selectedId=null; draw();
  }, {passive:false});
  canvas.addEventListener('touchmove', e=>{
    if(pinch.active && e.touches.length===2 && selectedId){
      const s = stickers.find(x=>x.id===selectedId);
      const {dist, angle} = getTwoTouchData(e);
      const k = dist / pinch.dist0;
      s.scale = Math.max(1e-6, Math.min(8, pinch.scale0 * k));
      s.angle = pinch.angleStart + (angle - pinch.angle0);
      $('#scaleRange').value = s.scale;
      $('#rotateRange').value = (s.angle * 180 / Math.PI).toFixed(0);
      draw();
      e.preventDefault(); return;
    }
    const p=getPointer(e);
    if(dragging && selectedId){
      const s=stickers.find(x=>x.id===selectedId);
      s.x=p.x-dragOffset.x; s.y=p.y-dragOffset.y; draw(); e.preventDefault();
    }
  }, {passive:false});
  window.addEventListener('touchend', ()=>{ if(pinch.active) pinch.active=false; dragging=false; rotating=false; });

  // Wheel (desktop)
  canvas.addEventListener('wheel', e=>{
    if(!selectedId) return;
    const s=stickers.find(x=>x.id===selectedId);
    const delta = e.deltaY<0?1.06:0.94;
    s.scale=Math.max(1e-6,Math.min(8,s.scale*delta));
    $('#scaleRange').value=s.scale; draw(); e.preventDefault();
  }, {passive:false});

  // UI
  $('#uploadBtn').addEventListener('click', ()=> $('#upload').click());
  $('#upload').addEventListener('change', e=>{ const f=e.target.files[0]; if(f) loadBaseFromFile(f); });
  $('#exportBtn').addEventListener('click', exportPNG);
  $('#clearBtn').addEventListener('click', removeSelected);
  $('#frontBtn').addEventListener('click', bringToFront);
  $('#flipBtn').addEventListener('click', flipSelected);
  $('#clearBgBtn').addEventListener('click', clearBackground);
  $('#scaleRange').addEventListener('input', e=>{
    if(!selectedId) return;
    const s=stickers.find(x=>x.id===selectedId);
    s.scale=Math.max(1e-6, parseFloat(e.target.value)); draw();
  });
  $('#rotateRange').addEventListener('input', e=>{
    if (!selectedId) return;
    const s = stickers.find(x => x.id === selectedId);
    s.angle = parseFloat(e.target.value) * Math.PI / 180; draw();
  });

  function flipSelected(){ if(!selectedId) return; const s=stickers.find(x=>x.id===selectedId); s.flipX = !s.flipX; draw(); }
  function bringToFront(){ if(!selectedId) return; const idx=stickers.findIndex(x=>x.id===selectedId); if(idx>-1){ const s=stickers.splice(idx,1)[0]; stickers.push(s); draw(); } }
  function removeSelected(){ if(!selectedId) return; const i=stickers.findIndex(x=>x.id===selectedId); if(i>-1){ stickers.splice(i,1); selectedId=null; draw(); } }

  function exportPNG(){
    draw();
    const out = document.createElement('canvas');
    out.width = out.height = CANVAS_SIZE;
    const octx = out.getContext('2d');
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    octx.drawImage(canvas, 0,0, CANVAS_SIZE*dpr, CANVAS_SIZE*dpr, 0,0, CANVAS_SIZE, CANVAS_SIZE);
    const url=out.toDataURL('image/png');
    const a=document.createElement('a');
    const ts=new Date().toISOString().replace(/[:.]/g,'-');
    a.download=`USDUT_PFP_${ts}_${CANVAS_SIZE}x${CANVAS_SIZE}.png`; a.href=url; a.click();
  }

  function syncControlsFromSelection(){
    const s = stickers.find(x => x.id === selectedId);
    if(!s) return;
    $('#scaleRange').value = s.scale;
    $('#rotateRange').value = (s.angle * 180 / Math.PI).toFixed(0);
  }

  function buildLists(){
    const bg = document.getElementById('bgThumbs');
    const st = document.getElementById('presetThumbs');
    if(!bg || !st) return;
    buildBackgroundThumbs();
    buildPresetThumbs();
  }

  // Init
  buildLists();
  setupHiDPI();
</script>
</body>
</html>
